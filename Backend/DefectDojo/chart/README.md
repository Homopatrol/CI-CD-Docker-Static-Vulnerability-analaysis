## Introduction

This chart install Defectdojo with a PostgreSQL Database.

## Pre-requistes

- Kubernetes 1.10+
- Ensure you have access to the required sub-charts:

```console
$ helm repo add bitnami https://charts.bitnami.com/bitnami
"bitnami" has been added to your repositories

$ helm repo add stable https://charts.helm.sh/stable
"stable" has been added to your repositories
```

To install the chart:
```console
$ cd \Backend\DefectDojo\chart\charts
$ helm install <release_name> <path_to_chart> 
.....
NOTES:
DefectDojo has been installed.

To use it, go to <https://defectdojo.default.minikube.local>.

Log in with username admin.
To find out the password, run the following command:

    echo "DefectDojo admin password: $(kubectl \
      get secret test-dd-defectdojo \
      --namespace=default \
      --output jsonpath='{.data.DD_ADMIN_PASSWORD}' \
      | base64 --decode)"
```

## Upstream changes 

A collection of changes have been made to this chart to make it compliant when deployed on the OpenShift Environment.

[Values.yaml](./values.yaml)
```console
django:
....
  route:
    enabled: true
    ## Route is used instead of ingress when deploying this chart on OpenShift.
....
```
[django-route.yaml](./templates/django-route.yaml)
```console
{{- if .Values.django.route.enabled -}}
{{- $fullName := include "defectdojo.fullname" . -}}
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: {{ $fullName }}
  labels:
    defectdojo.org/component: django
    app.kubernetes.io/name: {{ include "defectdojo.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    helm.sh/chart: {{ include "defectdojo.chart" . }}
spec:
  host: {{ .Values.host }}
  port:
    targetPort: http
  tls:
    insecureEdgeTerminationPolicy: Redirect
    termination: edge
  to:
    kind: Service
    name: {{ $fullName }}-django
    weight: 100
  wildcardPolicy: None
{{- end }}
```

## Uninstalling the chart

To uninstall/delete the deployment:

```console
$ helm list
NAME          REVISION    UPDATED                     STATUS      CHART           NAMESPACE
<release_name> 1           Mon Oct  2 15:05:44 2017    DEPLOYED    sonarqube-0.1.0  default
$ helm delete <release_name>
```
You will also have to delete the persistantVolumeClaims for PostgreSQL and Rabbitmq

```console
$ oc get pvc
...
$ oc delete pvc <release_name>-postgresql-0 <release_name>-rabbitmq-0
```

## Configuration

The following table lists the configurable parameters of the Sonarqube chart and their default values.

| Parameter                                                | Description                                                                                                               | Default                         |
| -------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------- | ------------------------------- |
| `createSecret`                                           | create defectdojo specific secret                                                                                               | `true`                             |
| `createRabbitMqSecret`                                     | create rabbitmq secret in defectdojo chart, outside of rabbitmq chart                                                                                                  | `true`                            |
| `createRedisSecret`                                      | create redis secret in defectdojo chart, outside of redis chart                                                                                 | `false`               |
| `createMysqlSecret`                                          | create mysql secret in defectdojo chart, outside of mysql chart                                                                                                 | `false`                         |
| `createPostgresqlSecret`                                      | create postgresql secret in defectdojo chart, outside of postgresql chart                                                                               | `true`                         |
| `database`                                    | Configuration value to select database type                                | `postgresql`                          |
| `host`                                       | Ingress/Route domain                                                                                                        | `defectdojo-route.app-crc.testing`                     |
| `alternativeHosts`                                       | Optional list of alternative hostnames                                                                                                        | `defectdojo.example.com`                     
| `imagePullPolicy`                                              | Image pull policy                                                                                                    | `Always`               |
| `repositoryPrefix`                                       | Where to pull the defectDojo images from.                                                                                                         | `defectdojo`                  |
| `tag`                                       | Image tag                                                             | `latest`                |
| `securityContext.enabled`                                | Group applied to mounted directories/files                                                                                | `true`                          |
| `securityContext.djangoSecurityContext.runAsUser`                     | User to run containers in django pod as, unless overwritten                       | `1001`                          |
| `securityContext.nginxSecurityContext.runAsUser`                            | User to run containers in nginx pod as, unless overwritten                                                                              | `1001`                          |
| `tests.unitTests.resourcs.requests.cpu`                          | unitTests cpu request                                                                           | `100m`                          |
| `tests.unitTests.resourcs.requests.memory`                                           | unitTests memory request                                                                                                   | `128Mi`                     |
| `tests.unitTests.resourcs.limits.cpu`                                   | unitTests cpu limit                                                                                                   | `500m`                          |
| `tests.unitTests.resourcs.limits.memory`                                   | unitTests memory limit                                                                                                | `512Mi`                          |
| `admin.user`                                         | Kubernetes service labels                                                                                                 | None                            |
| `admin.password`                                    | Kubernetes service annotations                                                                                            | None                            |
| `admin.firstName`                       | Kubernetes service LB Allowed inbound IP addresses                                                                        | None                            |
| `admin.lastName`                                 | Kubernetes service LB Optional fixed external IP                                                                          | None                            |
| `admin.mail`                                       | Kubernetes service port of exposed on nodePort or LD                                                                      | None                            |
| `admin.secretKey`                                        | Flag for enabling ingress                                                                                                 | `false`                         |
| `admin.credentialAes256Key`                                         | Ingress additional labels                                                                                                 | `{}`                            |
| `admin.metricsHttpAuthPassword`                                  | Hostname to your SonarQube installation                                                                                   | `sonar.organization.com`        |
| `monitoring.enabled`                                  | Path within the URL structure                                                                                             | `false`                              |
| `monitoring.prometheus.enabled`                           | Optional field to override the default serviceName of a path                                                              | `false`                            |
| `monitoring.prometheus.image`                           | Optional field to override the default servicePort of a path                                                              | `nginx/nginx-prometheus-exporter:0.10.0`                            |
| `monitoring.prometheus.imagePullPolicy`                                            | Ingress secrets for TLS certificates                                                                                      | `IfNotPresent`                            |
| `annotations`                                               | Node / Pod affinities                                                                                                     | `{}`                            |
| `celery.broker`                                            | List of node taints to tolerate                                                                                           | `rabbitmq`                            |
| `celery.logLevel`                                           | Node labels for pod assignment                                                                                            | `INFO`                            |
| `celery.beat.annotations`                                            | Aliases for IPs in /etc/hosts                                                                                             | `{}`                            |
| `celery.beat.affinity`                      | ReadinessProbe initial delay for SonarQube checking                                                                       | `{}`                            |
| `celery.beat.nodeSelector`                           | ReadinessProbe period between checking SonarQube                                                                          | `{}`                            |
| `celery.beat.replicas`                        | ReadinessProbe thresold for marking as failed                                                                             | `1`                             |
| `celery.beat.resources.requests.cpu`                         | SonarQube web context for readinessProbe                                                                                  | `100m`                               |
| `celery.beat.resources.requests.memory`                       | LivenessProbe initial delay for SonarQube checking                                                                        | `128Mi`                            |
| `celery.beat.resources.limits.cpu`                            | LivenessProbe period between checking SonarQube                                                                           | `2000m`                            |
| `celery.beat.resources.requests.memory`                          | SonarQube web context for livenessProbe                                                                                   | `256Mi`                               |
| `celery.beat.tolerations`                                   | Change init container image                                                                                               | `[]`                  |
| `celery.worker.annotations`                         | SecurityContext for init containers                                                                                       | `{}`                           |
| `celery.worker.affinity`                               | Resources for init containers                                                                                             | `{}`                            |
| `celery.worker.logLevel`                                    | Extra init containers to e.g. download required artifacts                                                                 | `INFO`                            |
| `celery.worker.nodeSelector`                                          | Change init CA certificates container image                                                                               | `{}` |
| `celery.worker.replicas`                                         | Name of the secret containing additional CA certificates                                                                  | `1`                           |
| `celery.worker.resources.requests.cpu`                                     | Modify k8s worker to conform to system requirements                                                                       | `100M`                          |
| `celery.worker.resources.requests.memory`                               | Set init sysctl container vm.max_map_count                                                                                | `128Mi`                        |
| `celery.worker.resources.limits.cpu`                                   | Set init sysctl container fs.file-max                                                                                     | `200M`                        |
| `celery.worker.resources.limits.memory`                                      | Set init sysctl container open file descriptors limit                                                                     | `512Mi`                        |
| `celery.worker.tolerations`                                       | Set init sysctl container open threads limit                                                                              | `[] `                         |
| `celery.worker.app_settings.pool_type`                                       | Change init sysctl container image                                                                                        | `solo`                  |
| `celery.extraVolumes`                                       | Extra volumes to use                                                                                        | `[]`                  |
| `django.annotations`                             | InitSysctl container security context                                                                                     | `{}`            |
| `django.affinity`                                   | InitSysctl container resource requests & limits                                                                           | `{}`                            |
| `django.route.enabled`                                        | List of plugins to install                                                                                                | `true`                            |
| `django.ingress.enabled`                                        | List of plugins to install                                                                                                | `false`                            |
| `django.ingress.ingressClassName`                                            | Plugins libray                                                                                                            | `""`                            |
| `django.ingress.activateTLS`                                            | Plugins libray                                                                                                            | `[]`                            |
| `django.ingress.secretName`                                      | Plugin Pod resource requests & limits                                                                                     | `defectdojo-tls`                            |
| `django.ingress.annotations`                                      | For use behind a corporate proxy when downloading plugins                                                                 | `{}`                              |
| `django.nginx.tls.enabled`                                     | For use behind a corporate proxy when downloading plugins                                                                 | `false`                              |
| `django.nginx.tls.generateCertificate`                                        | For use behind a corporate proxy when downloading plugins                                                                 | `false`                              |
| `django.nginx.resources.requests.cpu`                                          | Image for plugins container                                                                                               | `100m`                              |
| `django.nginx.resources.requests.memory`                                      | Resources for plugins container                                                                                           | `128Mi`                              |
| `django.nginx.resources.limits.cpu`                                     | Name of the secret containing .netrc file to use creds when downloading plugins                                           | `2000m`                              |
| `django.nginx.resources.limits.memory`                             | Flag to not check server's certificate when downloading plugins                                                           | `256Mi`                         |
| `django.nginx.nodeSelector`                                                | Values to add to SONARQUBE_WEB_JVM_OPTS                                                                                   | `{}`                            |
| `django.nginx.replicas`                                                    | Environment variables to attach to the pods                                                                               | `1`                           |
| `django.nginx.tolerations`                                            | Sonarqube Pod annotations                                                                                                 | `[]`                            |
| `django.uwsgi.livenessProbe.enabled`                                              | Sonarqube Pod resource requests & limits                                                                                  | `true`                            |
| `django.uwsgi.livenessProbe.failureThreshold`                                    | Flag for enabling persistent storage                                                                                      | `6`                           |
| `django.uwsgi.livenessProbe.initialDelaySeconds`                                | Kubernetes pvc annotations                                                                                                | `120`                            |
| `django.uwsgi.livenessProbe.periodSeconds`                              | Do not create a new PVC but use this one                                                                                  | `10`                            |
| `django.uwsgi.livenessProbe.successThreshold`                               | Storage class to be used                                                                                                  | `1`                              |
| `django.uwsgi.livenessProbe.timeoutSeconds`                                 | Volumes access mode to be set                                                                                             | `5`                 |
| `django.uwsgi.resources.requests.cpu`                                       | Size of the volume                                                                                                        | `100m`                            |
| `django.uwsgi.resources.requests.memory`                                    | Specify extra volumes. Refer to ".spec.volumes" specification                                                             | `128Mi`                              |
| `django.uwsgi.limits.cpu`                                     | Specify extra mounts. Refer to ".spec.containers.volumeMounts" specification                                              | `2000m`                             |
| `django.uwsgi.limits.memory`                                               | Configuration of resources for `512Mi`                                                                                 | `{}`                            |
| `django.uwsgi.app_settings.processes`                                        | Custom `sonar.properties` file                                                                                            | `2`                            |
| `django.uwsgi.app_settings.threads`                                  | Additional `sonar.properties` file to load from a secret                                                                  | `2`                            |
| `django.uwsgi.enable_debugpy`                                         | Name of existing secret used for settings encryption                                                                      | `false`                            |
| `django.uwsgi.certificates.enabled`                                       | Type of the JDBC Database driver                                                                                          | `false`                     |
| `django.uwsgi.certificates.configName`                                        | Overrides default JDBC URL creation                                                                                       | `defectdojo-ca-certs`                            |
| `django.uwsgi.certificates.certMountPath`                               | Set to `true` to create the postgresql secret in Sonarqube chart, instead of postgresql chart                          | `/certs/`                        |
| `django.uwsgi.certificates.certFileName`                                     | Set to `false` to use external server                                                                                     | `ca.crt`                          |
| `django.extraVolumes`                                     | Specify extra volumes                                                                                    | `[]`  
| `mediaPersistentVolume.enabled`                                     | Enable Media persistance volumes                                                                                    | `true`  
| `mediaPersistentVolume.fsGroup`                                     | Specified fsGroup volumes                                                                                    | `1001`  
| `mediaPersistentVolume.name`                                     | Media Name volumes                                                                                    | `media`  
| `mediaPersistentVolume.type`                                     | Volume type volumes                                                                                    | `emptyDir`  
| `mediaPersistentVolume.persistentVolumeClaim`                                     | Specified PVC                                                                                    | `media`  
| `initializer.run`                                     | Run the Initializer script PVC                                                                                    | `true`  
| `initializer.annotations`                                     |  Specify annotations                                                                                    | `{}`  
| `initializer.keepSeconds`                                     |  Specify keepSeconds                                                                                 | `60`  
| `initializer.affinity`                                     | Specify affinity                                                                                    | `{}`  
| `initializer.nodeSelector`                                     |  Specify nodeSelector                                                                                    | `{}`  
| `initializer.resources.requests.cpu`                                     | Specify cpu                                                                                      | `100m`  
| `initializer.resources.requests.memory`                                     | Specify memory                                                                                      | `256Mi`  
| `initializer.resources.limits.cpu`                                     | Specify cpu limit                                                                                     | `2000m`  
| `initializer.resources.limits.memory`                                     | Specify memory limit                                                                                   | `512Mi`  
| `mysql.enabled`                                     | Enable MySQL database limit                                                                                   | `true`  
| `mysql.auth.username`                                     | MySQL DB username limit                                                                                   | `defectdojo`  
| `mysql.auth.password`                                     | MySQL DB password limit                                                                                   | `""`  
| `mysql.auth.rootPassword`                                     | MySQL DB root password limit                                                                                   | `""`
| `mysql.auth.database`                                     | MySQL DB name limit                                                                                   | `defectdojo`
| `mysql.auth.existingSecret`                                     | MySQL DB existingSecret name limit                                                                                   | `defectdojo-mysql-specific`
| `mysql.auth.secretKey`                                     | MySQL DB secretKey limit                                                                                   | `mysql-password`
| `mysql.master.service.port`                                     | MySQL Port limit                                                                                   | `512Mi`
| `postgresql.enabled`                              | Enable PostgreSQL DB         | `true`              |
| `postgresql.serviceAccount.enabled`                              | Enable ServiceAccount to run PostgreSQL DB         | `true`              |
| `postgresql.postgresqlUsername`                          | Postgresql database user                                                                                                  | `defectdojo`                     |
| `postgresql.postgresqlPassword`                          | Postgresql database password                                                                                              | `""`                     |
| `postgresql.postgresqlDatabase`                          | Postgresql database name                                                                                                  | `defectdojo`                       |
| `postgresql.existingSecret`                              | Secret containing the password of the external Postgresql server                                                          | `defectdojo-postgresql-specific`              |
| `postgresql.existingSecret`                   | Secret Key containing the password of the external Postgresql server                                                      | `defectdojo-postgresql-specific`           |
| `postgresql.secretKey`                              |                                                                                       | `postgresql-password`           |
| `postgresql.persistence.enabled`                         | Postgresql persistence en/disabled                                                                                        | `true`                          |
| `postgresql.replication.enabled`                         | Postgresql replication en/disabled                                                                                        | `true`                          |
| `postgresql.service.port`                                | Postgresql port                                                                                                           | `5432`
| `postgresql.securityContext.enabled`                            | Postgresql securityContext en/disabled                                                                               | `true`                          |
| `postgresql.securityContext.fsGroup`                            | Postgresql securityContext fsGroup                                                                               | `1001`                          |
| `postgresql.containerSecurityContext.enabled`                            | Postgresql containerSecurityContext en/disabled                                                                               | `true`                          |
| `postgresql.containerSecurityContext.fsGroup`                            | Postgresql securityContext fsGroup                                                                               | `1001`                          |
| `postgresql.volumePermissions.securityContext.enabled`                            | Postgresql volumePermissions en/disabled                                                                             | `true`                          |
| `postgresql.volumePermissions.securityContext.runAsUser`                            | Postgresql volumePermissions User                                                                               | `1001`                          |
| `postgresql.shmVolume.chmod.enabled`                            | Postgresql chmod en/disabled                                                                               | `false`                          |

| `postgresql.master.affinity`                     | Postgresql master affinity fsGroup                                                                                        | `{}`                          |
| `postgresql.master.nodeSelector`                    | Postgresql master node selector runAsUser                                                                                      | `{}`                          |
| `postgresql.slave.affinity`                   | Postgresql master node selector                                                                                      | `{}}`                         |
| `postgresql.slave.nodeSelector` | Postgresql master node selector                                                                             | `{}`                             |

| `cloudsql.enabled`                     | cloudsql en/disabled                                                                                  | `false`                         |
| `cloudsql.verbose`                      | cloudsql verbose                                                                           | `true`                         |
| `cloudsql.image.repository`                         | cloudsql image                                                                           | `gcr.io/cloudsql-docker/gce-proxy`                            |
| `cloudsql.image.tag`                         | cloudsql image tag                                                                        | `1.28.1`                            |
| `cloudsql.image.pullPolicy`                         | cloudsql image pull policy                                                                        | `IfNotPresent`                            |
| `cloudsql.instance`                         | set CloudSQL instancel policy                                                                        | `""`                            |
| `cloudsql.enable_iam_login`                         | use IAM database authentication policy                                                                        | `false`                            |
| `cloudsql.use_private_ip`                         | Specify a private IP to connect to the database policy                                                                        | `false`                            |
| `gke.useGKEIngress`                         | en/disable the GKE provided ingress controller                                                                        | `false`                            |
| `gke.useManagedCertificate`                         |  en/disable GKE automatically provision a TLS certificate policy                                                                        | `false`                            |
| `gke.workloadIdentityEmail`                         | Allow the K8s service account to assume the IAM access policy                                                                        | `""`                            |
| `rabbitmq.enabled`                         | en/disable rabbitmq                                                                        | `true`                            |
| `rabbitmq.replicaCount`                         | rabbitmq replicaCount                                                                       | `1`                            |
| `rabbitmq.auth.password`                         | rabbitmq password                                                                       | `""`                            |
| `rabbitmq.auth.erlangCookie`                         | rabbitmq erlangCookie                                                                       | `""`                            |
| `rabbitmq.auth.existingPasswordSecret`                         | rabbitmq existingPasswordSecret                                                                       | `defectdojo-rabbitmq-specific`                            |
| `rabbitmq.auth.secretPasswordKey`                         | rabbitmq secretPasswordKey                                                                       | `""`                            |
| `rabbitmq.auth.existingErlangSecret`                         | rabbitmq existingErlangSecret                                                                        | `defectdojo-rabbitmq-specific`                            |
| `rabbitmq.memoryHighWatermark.enabled`                         | en/disable rabbitmq  memoryHighWatermark                                                                  | `true`                            |
| `rabbitmq.memoryHighWatermark.type`                         |  rabbitmq memoryHighWatermark type                                                                | `relative`                            |
| `rabbitmq.memoryHighWatermark.value`                         |  rabbitmq memoryHighWatermark    value                                                            | `0.5`                            |
| `rabbitmq.affinity`                         | rabbitmq affinity                                                                       | `{}`                            |
| `rabbitmq.nodeSelector`                         | rabbitmq nodeSelector                                                                      | `{}`                            |
| `rabbitmq.resources.requests.cpu`                         | rabbitmq requests cpu                                                                        | `100m`                            |
| `rabbitmq.resources.requests.memory`                         | rabbitmq requests memory                                                                        | `128Mi`                            |
| `rabbitmq.resources.limits.cpu`                         | rabbitmq requests cpu                                                                        | `500m`                            |
| `rabbitmq.resources.limits.memory`                         | rabbitmq requests memory                                                                        | `512Mi`                            |
| `rabbitmq.podSecurityContext.enabled`                         | en/disable podSecurityContext                                                                         | `true`                            |
| `rabbitmq.podSecurityContext.fsGroup`                         | rabbitmq fsGroup                                                                        | `1001`                            |
| `rabbitmq.podSecurityContext.runAsUser`                         | rabbitmq user                                                                        | `1001`                            |
| `redis.enabled`                         |  en/disable redis                                                                        | `false`                            |
| `redis.transportEncryption.enabled`                         |  en/disable redis transportEncryption                                                                        | `false`                            |
| `redis.transportEncryption.params`                         | redis transportEncryption params                                                                        | `""`                            |
| `redis.auth.existingSecret`                         | redis existingSecret                                                                        | `defectdojo-redis-specific`                            |
| `redis.auth.existingSecretPasswordKey`                         | redis existingSecretPasswordKey                                                                        | `redis-password`                            |
| `redis.auth.password`                         | redis password                                                                        | `""`                            |
| `redis.architecture`                         | redis architecture                                                                        | `standalone`                            |
| `redis.extraConfigs`                         | redis extraConfigs                                                                        | `{}`                            |