## Introduction

This chart install Defectdojo with a PostgreSQL Database.

## Pre-requistes

- Kubernetes 1.10+
- Ensure you have access to the required sub-charts:

```console
$ helm repo add bitnami https://charts.bitnami.com/bitnami
"bitnami" has been added to your repositories

$ helm repo add stable https://charts.helm.sh/stable
"stable" has been added to your repositories
```

To install the chart:
```console
$ cd \Backend\DefectDojo\chart\charts
$ helm install <release_name> <path_to_chart> 
.....
NOTES:
DefectDojo has been installed.

To use it, go to <https://defectdojo.default.minikube.local>.

Log in with username admin.
To find out the password, run the following command:

    echo "DefectDojo admin password: $(kubectl \
      get secret test-dd-defectdojo \
      --namespace=default \
      --output jsonpath='{.data.DD_ADMIN_PASSWORD}' \
      | base64 --decode)"
```


## Uninstalling the chart

To uninstall/delete the deployment:

```console
$ helm list
NAME          REVISION    UPDATED                     STATUS      CHART           NAMESPACE
<release_name> 1           Mon Oct  2 15:05:44 2017    DEPLOYED    sonarqube-0.1.0  default
$ helm delete <release_name>
```
You will also have to delete the persistantVolumeClaims for PostgreSQL and Rabbitmq

```console
$ oc get pvc
...
$ oc delete pvc <release_name>-postgresql-0 <release_name>-rabbitmq-0
```

## Configuration

The following table lists the configurable parameters of the Sonarqube chart and their default values.

| Parameter                                                | Description                                                                                                               | Default                         |
| -------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------- | ------------------------------- |
| `createSecret`                                           | create defectdojo specific secret                                                                                               | `true`                             |
| `createRabbitMqSecret`                                     | create rabbitmq secret in defectdojo chart, outside of rabbitmq chart                                                                                                  | `true`                            |
| `createRedisSecret`                                      | create redis secret in defectdojo chart, outside of redis chart                                                                                 | `false`               |
| `createMysqlSecret`                                          | create mysql secret in defectdojo chart, outside of mysql chart                                                                                                 | `false`                         |
| `createPostgresqlSecret`                                      | create postgresql secret in defectdojo chart, outside of postgresql chart                                                                               | `true`                         |
| `database`                                    | Configuration value to select database type                                | `postgresql`                          |
| `host`                                       | Ingress/Route domain                                                                                                        | `defectdojo-route.app-crc.testing`                     |
| `imagePullPolicy`                                              | Image pull policy                                                                                                    | `Always`               |
| `repositoryPrefix`                                       | Where to pull the defectDojo images from.                                                                                                         | `defectdojo`                  |
| `tag`                                       | Image tag                                                             | `latest`                |
| `securityContext.enabled`                                | Group applied to mounted directories/files                                                                                | `true`                          |
| `securityContext.djangoSecurityContext.runAsUser`                     | User to run containers in django pod as, unless overwritten                       | `1001`                          |
| `securityContext.nginxSecurityContext.runAsUser`                            | User to run containers in nginx pod as, unless overwritten                                                                              | `1001`                          |
| `tests.unitTests.resourcs.requests.cpu`                          | unitTests cpu request                                                                           | `100m`                          |
| `tests.unitTests.resourcs.requests.memory`                                           | unitTests memory request                                                                                                   | `128Mi`                     |
| `tests.unitTests.resourcs.limits.cpu`                                   | unitTests cpu limit                                                                                                   | `500m`                          |
| `tests.unitTests.resourcs.limits.memory`                                   | unitTests memory limit                                                                                                | `512Mi`                          |
| `admin.user`                                         | Kubernetes service labels                                                                                                 | None                            |
| `admin.password`                                    | Kubernetes service annotations                                                                                            | None                            |
| `admin.firstName`                       | Kubernetes service LB Allowed inbound IP addresses                                                                        | None                            |
| `admin.lastName`                                 | Kubernetes service LB Optional fixed external IP                                                                          | None                            |
| `admin.mail`                                       | Kubernetes service port of exposed on nodePort or LD                                                                      | None                            |
| `admin.secretKey`                                        | Flag for enabling ingress                                                                                                 | false                           |
| `admin.credentialAes256Key`                                         | Ingress additional labels                                                                                                 | `{}`                            |
| `admin.metricsHttpAuthPassword`                                  | Hostname to your SonarQube installation                                                                                   | `sonar.organization.com`        |
| `monitoring.enabled`                                  | Path within the URL structure                                                                                             | /                               |
| `monitoring.prometheus.enabled`                           | Optional field to override the default serviceName of a path                                                              | None                            |
| `monitoring.prometheus.image`                           | Optional field to override the default servicePort of a path                                                              | None                            |
| `monitoring.prometheus.imagePullPolicy`                                            | Ingress secrets for TLS certificates                                                                                      | `[]`                            |
| `annotations`                                               | Node / Pod affinities                                                                                                     | `{}`                            |
| `celery.broker`                                            | List of node taints to tolerate                                                                                           | `[]`                            |
| `celery.logLevel`                                           | Node labels for pod assignment                                                                                            | `{}`                            |
| `celery.beat.annotations`                                            | Aliases for IPs in /etc/hosts                                                                                             | `[]`                            |
| `celery.beat.affinity`                      | ReadinessProbe initial delay for SonarQube checking                                                                       | `60`                            |
| `celery.beat.nodeSelector`                           | ReadinessProbe period between checking SonarQube                                                                          | `30`                            |
| `celery.beat.replicas`                        | ReadinessProbe thresold for marking as failed                                                                             | `6`                             |
| `celery.beat.resources.requests.cpu`                         | SonarQube web context for readinessProbe                                                                                  | /                               |
| `celery.beat.resources.requests.memory`                       | LivenessProbe initial delay for SonarQube checking                                                                        | `60`                            |
| `celery.beat.resources.limits.cpu`                            | LivenessProbe period between checking SonarQube                                                                           | `30`                            |
| `celery.beat.resources.requests.memory`                          | SonarQube web context for livenessProbe                                                                                   | /                               |
| `celery.beat.tolerations`                                   | Change init container image                                                                                               | `busybox:1.32`                  |
| `celery.worker.annotations`                         | SecurityContext for init containers                                                                                       | `nil`                           |
| `celery.worker.affinity`                               | Resources for init containers                                                                                             | `{}`                            |
| `celery.worker.logLevel`                                    | Extra init containers to e.g. download required artifacts                                                                 | `{}`                            |
| `celery.worker.nodeSelector`                                          | Change init CA certificates container image                                                                               | `adoptopenjdk/openjdk11:alpine` |
| `celery.worker.replicas`                                         | Name of the secret containing additional CA certificates                                                                  | `nil`                           |
| `celery.worker.resources.requests.cpu`                                     | Modify k8s worker to conform to system requirements                                                                       | `true`                          |
| `celery.worker.resources.requests.memory`                               | Set init sysctl container vm.max_map_count                                                                                | `524288`                        |
| `celery.worker.resources.limits.cpu`                                   | Set init sysctl container fs.file-max                                                                                     | `131072`                        |
| `celery.worker.resources.limits.memory`                                      | Set init sysctl container open file descriptors limit                                                                     | `131072`                        |
| `celery.worker.tolerations`                                       | Set init sysctl container open threads limit                                                                              | `8192 `                         |
| `celery.worker.app_settings.pool_type`                                       | Change init sysctl container image                                                                                        | `busybox:1.32`                  |
| `django.annotations`                             | InitSysctl container security context                                                                                     | `{privileged: true}`            |
| `django.affinity`                                   | InitSysctl container resource requests & limits                                                                           | `{}`                            |
| `django.ingress.enabled`                                        | List of plugins to install                                                                                                | `[]`                            |
| `django.ingress.activateTLS`                                            | Plugins libray                                                                                                            | `[]`                            |
| `django.ingress.secretName`                                      | Plugin Pod resource requests & limits                                                                                     | `{}`                            |
| `django.ingress.annotations`                                      | For use behind a corporate proxy when downloading plugins                                                                 | ""                              |
| `django.nginx.tls.enabled`                                     | For use behind a corporate proxy when downloading plugins                                                                 | ""                              |
| `django.nginx.tls.generateCertificate`                                        | For use behind a corporate proxy when downloading plugins                                                                 | ""                              |
| `django.nginx.resources.requests.cpu`                                          | Image for plugins container                                                                                               | ""                              |
| `django.nginx.resources.requests.memory`                                      | Resources for plugins container                                                                                           | ""                              |
| `django.nginx.resources.limits.cpu`                                     | Name of the secret containing .netrc file to use creds when downloading plugins                                           | ""                              |
| `django.nginx.resources.limits.memory`                             | Flag to not check server's certificate when downloading plugins                                                           | `false`                         |
| `django.nginx.nodeSelector`                                                | Values to add to SONARQUBE_WEB_JVM_OPTS                                                                                   | `""`                            |
| `django.nginx.replicas`                                                    | Environment variables to attach to the pods                                                                               | `nil`                           |
| `django.nginx.tolerations`                                            | Sonarqube Pod annotations                                                                                                 | `{}`                            |
| `django.uwsgi.livenessProbe.enabled`                                              | Sonarqube Pod resource requests & limits                                                                                  | `{}`                            |
| `django.uwsgi.livenessProbe.failureThreshold`                                    | Flag for enabling persistent storage                                                                                      | false                           |
| `django.uwsgi.livenessProbe.initialDelaySeconds`                                | Kubernetes pvc annotations                                                                                                | `{}`                            |
| `django.uwsgi.livenessProbe.periodSeconds`                              | Do not create a new PVC but use this one                                                                                  | None                            |
| `django.uwsgi.livenessProbe.successThreshold`                               | Storage class to be used                                                                                                  | ""                              |
| `django.uwsgi.livenessProbe.timeoutSeconds`                                 | Volumes access mode to be set                                                                                             | `ReadWriteOnce`                 |
| `django.uwsgi.resources.requests.cpu`                                       | Size of the volume                                                                                                        | 10Gi                            |
| `django.uwsgi.resources.requests.memory`                                    | Specify extra volumes. Refer to ".spec.volumes" specification                                                             | []                              |
| `django.uwsgi.limits.cpu`                                     | Specify extra mounts. Refer to ".spec.containers.volumeMounts" specification                                              | []                              |
| `django.uwsgi.limits.memory`                                               | Configuration of resources for `emptyDir`                                                                                 | `{}`                            |
| `django.uwsgi.app_settings.processes`                                        | Custom `sonar.properties` file                                                                                            | None                            |
| `django.uwsgi.app_settings.threads`                                  | Additional `sonar.properties` file to load from a secret                                                                  | None                            |
| `django.uwsgi.enable_debugpy`                                         | Name of existing secret used for settings encryption                                                                      | None                            |
| `django.uwsgi.certificates.enabled`                                       | Type of the JDBC Database driver                                                                                          | `postgreql`                     |
| `django.uwsgi.certificates.configName`                                        | Overrides default JDBC URL creation                                                                                       | None                            |
| `django.uwsgi.certificates.certMountPath`                               | Set to `true` to create the postgresql secret in Sonarqube chart, instead of postgresql chart                          | `true`                        |
| `django.uwsgi.certificates.certFileName`                                     | Set to `false` to use external server                                                                                     | `true`                          |



| `postgresql.existingSecret`                              | Secret containing the password of the external Postgresql server                                                          | `sonar-postgresql`              |
| `postgresql.secretKey`                                  |                                                                                                                            | `postgresql-password`           |
| `postgresql.existingSecretPasswordKey`                   | Secret Key containing the password of the external Postgresql server                                                      | `postgresql-password`           |
| `postgresql.postgresqlServer`                            | Hostname of the external Postgresql server                                                                                | `null`                          |
| `postgresql.postgresqlUsername`                          | Postgresql database user                                                                                                  | `sonarUser`                     |
| `postgresql.postgresqlPassword`                          | Postgresql database password                                                                                              | `""`                     |
| `postgresql.postgresqlDatabase`                          | Postgresql database name                                                                                                  | `sonarDB`                       |
| `postgresql.service.port`                                | Postgresql port                                                                                                           | `5432`                          |
| `postgresql.resources.requests.memory`                   | Postgresql memory request                                                                                                 | `256Mi`                         |
| `postgresql.resources.requests.cpu`                      | Postgresql cpu request                                                                                                    | `250m`                          |
| `postgresql.resources.limits.memory`                     | Postgresql memory limit                                                                                                   | `2Gi`                           |
| `postgresql.resources.limits.cpu`                        | Postgresql cpu limit                                                                                                      | `2`                             |
| `postgresql.persistence.enabled`                         | Postgresql persistence en/disabled                                                                                        | `true`                          |
| `postgresql.persistence.accessMode`                      | Postgresql persistence accessMode                                                                                         | `ReadWriteOnce`                 |
| `postgresql.persistence.size`                            | Postgresql persistence size                                                                                               | `20Gi`                          |
| `postgresql.persistence.storageClass`                    | Postgresql persistence storageClass                                                                                       | `""`                            |
| `postgresql.securityContext.enabled`                     | Postgresql securityContext en/disabled                                                                                    | `true`                          |
| `postgresql.securityContext.fsGroup`                     | Postgresql securityContext fsGroup                                                                                        | `1001`                          |
| `postgresql.securityContext.runAsUser`                   | Postgresql securityContext runAsUser                                                                                      | `1001`                          |
| `postgresql.volumePermissions.enabled`                   | Postgres vol permissions en/disabled                                                                                      | `false`                         |
| `postgresql.volumePermissions.securityContext.runAsUser` | Postgres vol permissions secContext runAsUser                                                                             | `0`                             |
| `postgresql.shmVolume.chmod.enabled`                     | Postgresql shared memory vol en/disabled                                                                                  | `false`                         |
| `postgresql.serivceAccount.enabled`                      | Postgresql service Account creation en/disabled                                                                           | `false`                         |
| `postgresql.serivceAccount.name`                         | Postgresql service Account name (commented out)                                                                           | `""`                            |
| `podLabels`                                              | Map of labels to add to the pods                                                                                          | `{}`                            |
| `sonarqubeFolder`                                        | Directory name of Sonarqube                                                                                               | `/opt/sonarqube`                |
| `tests.enabled`                                          | Flag that allows tests to be excluded from generated yaml                                                                 | true                            |
| `tests.image`                                            | Change init test container image                                                                                          | `dduportal/bats:0.4.0`          |
| `serviceAccount.create`                                  | If set to true, create a serviceAccount                                                                                   | false                           |
| `serviceAccount.name`                                    | Name of the serviceAccount to create/use                                                                                  | `sonarqube-sonarqube`           |
| `serviceAccount.annotations`                             | Additional serviceAccount annotations                                                                                     | `{}`                            |
| `extraConfig.secrets`                                    | A list of `Secret`s (which must contain key/value pairs) which may be loaded into the Scanner as environment variables    | `[]`                            |
| `extraConfig.configmaps`                                 | A list of `ConfigMap`s (which must contain key/value pairs) which may be loaded into the Scanner as environment variables | `[]`                            |
| `account.adminPassword`                                  | Custom admin password                                                                                                     | `"admin"`                       |
| `account.currentAdminPassword`                           | Current admin password                                                                                                    | `"admin"`                       |
| `curlContainerImage`                                     | Curl container image                                                                                                      | `"curlimages/curl:latest"`      |
| `adminJobAnnotations`                                    | Custom annotations for admin hook Job                                                                                     | `{}`                            |
| `terminationGracePeriodSeconds`                          | Configuration of `terminationGracePeriodSeconds`                                                                          | `60`                            |

