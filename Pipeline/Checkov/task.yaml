apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: checkov-scan-dockerfile-task
spec:
  inputs:
    resources: 
    - name: git-source
      type: git
    params:
     - name: Dojo-Product-Name
       description: The Name of the Product in DefectDojo
     - name: Dojo-Engagement-Name
       description: The Name of the Engagement in DefectDojo
  steps:
    - name: checkov-report
      image: bridgecrew/checkov:latest
      resources: {}
      workingDir: /workspace/git-source
      script:
       mkdir /checkov
       cd /checkov
       checkov -s -f Dockerfile -o /checkov/results.json 
    - name: upload-report
      image: pandoraholladay/ddcicd:4
      imagePullPolicy: Always
      resources: {}
      workingDir: /workspace/git-source
      script: python /defectdojo_api/dojo_ci_cd.py --host ${DD_URL} --api_token 950fc6f54ff69b4b190d7b86ba51ecee25ecd1d3 --product_name $(inputs.params.Dojo-Product-Name) --engagement_name $(inputs.params.Dojo-Engagement-Name)  --user ${DD_USER}  --dir /workspace/git-source/checkov --scanner checkov
      env:
         - name: DD_API_KEY
           valueFrom:
             secretKeyRef:
               key: dojo-secret.apikey
               name: dojo-secret
         - name: DD_USER
           valueFrom:
             secretKeyRef:
               key: dojo-secret.username
               name: dojo-secret
         - name: DD_URL
           valueFrom:
             configMapKeyRef:
                 name: dojo-configmap
                 key: dojo-configmap.url
