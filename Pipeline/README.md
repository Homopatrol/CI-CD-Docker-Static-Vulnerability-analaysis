# CI/CD Pipeline Components

**Note** to install OpenShift Pipelines see [here](../README.md/#installing-openshift-pipelines)

## Overviewci-cd-scan-dockerfile-pipeline

This project uses a CI/CD Pipeline to complete two steps:
 - Scanning a Dockerfile for vulnerabilities using the scanners [kics]() and [Checkov]()
 - Uploading the scan reports generated to [DefectDojo]() for review

Two CI/CD Pipelines have been produced, `upload-report-pipeline` and `ci-cd-scan-dockerfile-pipeline`

 - [Deploying the DefectDojo ConfigMap](#deploying-the-defectdojo-configmap)
 - [Deploying the DefectDojo Secret](#deploying-the-defectdojo-secret)
 - [Deploying the PipelineResource](#deploying-the-pipelineresource)
 - [upload-report-pipeline](#upload-report-pipeline)
   - [Deploying the Task](#deploying-the-task)
   - [Deploying the Pipeline](#deploying-the-pipeline)
   - [Deploying the PipelineRun](#deploying-the-pipelinerun)
 - [ci-cd-scan-dockerfile-pipeline](#ci-cd-scan-dockerfile-pipeline)
   - [Deploying the Task](#deploying-the-task)
   - [Deploying the Pipeline](#deploying-the-pipeline)
   - [Deploying the PipelineRun](#deploying-the-pipelinerun)

## Deploying the DefectDojo ConfigMap
The ConfigMap stores environment variables in a single variable that can be accessed by multiple containers, this removes the need to configure a variable multiple times.

The [DefectDojo-ConfigMap](./defectdojo-configmap.yaml) stores the DefectDojo URL, which is required to send API requests.

The URL is assigned to the variable `dojo-configmap.url` below.

```consoleb
apiVersion: v1
kind: ConfigMap
metadata:
  name: dojo-configmap
  namespace: default
data:
defectdojo-configmap.yaml 
  dojo-configmap.url: https://<release_name>-.apps-crc.testing 
  ## Note by default the <release_name> is set as defectdojo-route, if you wish to change this URL you must update the host value in the DefectDojo chart values.yaml
  ## Note .apps-crc.testing is the external domain you are hosting DefectDojo on, this may be different if you are not using Code ready Containers.
```

To deploy the ConfigMap template perform
```console
oc create -f defectdojo-configmap.yaml
```

## Deploying the DefectDojo Secret
Similar to the ConfigMap, a Secret stores sensitive information in a single file and encrypts it in base64

The [DefectDojo-Secret](./defectdojo-secret.yaml) stores the DefectDojo User and their associated API token, this authenticates API requests sent to the DefectDojo application.

The default user in the variable `dojo-secret.username` is `admin`, however this can be set to any user created in DefectDojo.

The variable `dojo-secret.apikey` is retrieved by loggin into the DefectDojo Application and clicking on the user icon in the top right and selecting `API v2 Key`

```console 
apiVersion: v1
kind: Secret
metadata:
  name: dojo-secret
  namespace: default
type: Opaque
stringData:
  dojo-secret.username: admin
  dojo-secret.apikey: <>
```

To deploy the Secret template perform
```console
oc create -f defectdojo-secret.yaml
```

## Deploying the PipelineResource

```console
apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
  name: <resource_name> ## test-resource
  namespace: default
spec:
  type: git
  params:
    - name: url
      value: <git_repository_url> ## 'https://github.com/Homopatrol/testDockerfiles'
    - name: revision
      value: <branch_name> ## main
```

To deploy the PipelineResource template perform

```console
oc create -f pipelineresource.yaml
```
   
## upload-report-pipeline

[upload-report-pipeline](./upload-scan-pipeline.yaml) consists  test the uploading functionality and 

### Deploying the Task

```console
apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: upload-report-task
...
...
  steps:
    - name: upload-report
      image: pandoraholladay/ddcicd:6
      resources: {}
      workingDir: /defectdojo_api/
      script:
         python dojo_ci_cd.py --host ${DD_URL} --user ${DD_USER} --api_token ${DD_API_KEY} --product_name $(inputs.params.Dojo-Product-Name) --engagement_name $(inputs.params.Dojo-Engagement-Name) --dir /workspace/git-source/testDockerfile --scanner burp --branch_name $(inputs.params.Branch-Name)
...    
```

To deploy the Task template perform

```console
oc create -f upload-scan-task.yaml
```

### Deploying the Pipeline

To deploy the Pipeline template perform

```console
oc create -f upload-scan-pipeline.yaml
```

### Deploying the PipelineRun

Configure the following values in the specific [pipelinerun](./upload-report-pipelinerun.yaml) file.

### Deploying the PipelineRun

The pipelinerun template for the upload-report-pipeline is located [here](./upload-report-pipelinerun.yaml)

You must set the following parameters prior to deployment.
```console
....
   - name: git-source
     resourceRef:
       name: <Pipeline_resource> # test-report
  params: 
  - name: Dojo-Product-Name
    value: example_product # Name of the Product to be created in DefectDojo
  - name: Dojo-Engagement-Name
    value: example_enagment # Name of the Engagement to be created in DefectDojo
  - name: Branch_Name
    value: main # Name of the Git repository Branch being scanned
```

Then deploy the PipelineRun YAML file via the command line by performing:
```console
oc create -f upload-report-pipelinerun.yaml
```

##  ci-cd-scan-dockerfile-pipeline

 - [ci-cd-scan-dockerfile-pipeline](./ci-cd-scan-pipeline) uses KICS and Checkov to generate a scan report and uploads this to DefectDojo

The containers for Checkov and Kics both run under the root user as identified in these issues ([checkov](https://github.com/bridgecrewio/checkov/pull/1499) & [kics](https://github.com/Checkmarx/kics/pull/4057)). Therefore, the Kics and Checkov containes have been adapted to add a USER that is specified by UID to ensure that the Dockefile is compliant with Openshifts SCC that specifies "mustRunAsNonRoot".

### Deploying the Task

#### Checkov 

The Dockerfile image for the container `pandoraholladay/checkov` can be found [here](./checkov/Dockerfile/Dockerfile)

```console
apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: checkov-scan-dockerfile-task
...
  steps:
    - name: checkov-report
      image: bridgecrew/checkov:latest
      resources: {}
      workingDir: /workspace/git-source
      script:
       mkdir /workspace/checkov/
       
       checkov -s -f /workspace/git-source/Dockerfile -o json > /workspace/checkov/results.json
...
```

To deploy the Checkov Task template perform

```console
oc create -f checkov-task.yaml
```

#### KICS

The Dockerfile image for the container `pandoraholladay/kics` can be found [here](./kics/Dockerfile/Dockerfile)

```console
apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: kics-scan-dockerfile-task
...
  steps:
    - name: kics-report
      image: pandoraholladay/kics:1
      resources: {}
      workingDir: /workspace/git-source
      script:
       mkdir /workspace/kics/
       
       kics scan -p /workspace/git-source/Dockerfile --ignore-on-exit all -s -o /workspace/kics/
...
```

To deploy the Kics Task template perform

```console
oc create -f kics-task.yaml
```

### Deploying the Pipeline

To deploy the Pipeline template perform

```console
oc create -f ci-cd-scan-pipeline.yaml
```

### Deploying the PipelineRun

The pipelinerun template for the ci-cd-pipeline is located [here](./ci-cd-scan-dockerfile-pipelinerun.yaml)

You must set the following parameters prior to deployment.
```console
....
  resources:
   - name: git-source
     resourceRef:
       name: <Pipeline_resource> # vulnerable-dockerfile
  params: 
  - name: Dojo-Product-Name
    value: example_product # Name of the Product to be created in DefectDojo
  - name: Dojo-Engagement-Name
    value: example_enagment # Name of the Engagement to be created in DefectDojo
  - name: Branch_Name
    value: main # Name of the Git repository Branch being scanned
```
Then deploy the PipelineRun YAML file via the command line by performing:

```console
oc create -f ci-cd-dockerfile-scan-pipelinerun.yaml
```
