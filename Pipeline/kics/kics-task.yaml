apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: kics-scan-dockerfile-task
spec:
  inputs:
    resources: 
    - name: git-source
      type: git
    params:
     - name: Dojo-Product-Name
       description: The Name of the Product in DefectDojo
     - name: Dojo-Engagement-Name
       description: The Name of the Engagement in DefectDojo
  steps:
    - name: kics-report
      image: checkmarx/kics:latest
      resources: {}
      workingDir: /workspace/git-source
      script:
       mkdir /kics
       cd /kics
       kics scan --minimal-ui -o /kics/results.json 
    - name: upload-report
      image: pandoraholladay/ddcicd:2
      resources: {}
      workingDir: /workspace/git-source
      script: python /defectdojo_api/dojo_ci_cd.py --host ${DD_URL} --api_token 950fc6f54ff69b4b190d7b86ba51ecee25ecd1d3 --product_name $(inputs.params.Dojo-Product-Name) --engagement_name $(inputs.params.Dojo-Engagement-Name) --user ${DD_USER}  --dir /workspace/git-source/kics --scanner kics
      env:
         - name: DD_API_KEY
           valueFrom:
             secretKeyRef:
               key: dojo-secret.apikey
               name: dojo-secret
         - name: DD_USER
           valueFrom:
             secretKeyRef:
               key: dojo-secret.username
               name: dojo-secret
         - name: DD_URL
           valueFrom:
             configMapKeyRef:
                 name: dojo-configmap
                 key: dojo-configmap.url
