
# Overview

This example uses the bad-dockerfile developed by [ianmiell](https://github.com/ianmiell/bad-dockerfile)

To migrate a Gitea repository from an existing GitHub repository simply click on the "+" Icon, select New Migration -> GitHub and enter the repository URL. 
You can choose to make this migrations a mirror, this will restrict your ability to apply changes to the Gitea Repository. Therefore, this guide provides solutions for both standarded and mirrored Gitea repositories.

 - [Setting up a Gitea Repository](#setting-up-a-gitea-repository)
   - [Example Json payload for a Gitea Repository](#Example-Json-payload-for-a-Gitea-repository)
 - [Setting up a Mirrored Repository](#setting-up-a-mirrored-repository)
   - [Example Json payload for a mirrored repository](#Example-Json-payload-for-a-mirrored-repository)
 - [CEL Filter](#cel-filter)
 - [CEL Overlay](#cel-overlay)

## Setting up a Gitea Repository

### Example Json payload for a Gitea Repository
```console
Header

Request URL: http://eventlistener.apps-crc.testing/ 
Request method: POST 
Content-Type: application/json 
X-GitHub-Delivery: 50b27220-76e0-409a-b920-e95595873a12 
X-GitHub-Event: push 
X-Gitea-Delivery: 50b27220-76e0-409a-b920-e95595873a12 
X-Gitea-Event: push 
X-Gitea-Signature:  
X-Gogs-Delivery: 50b27220-76e0-409a-b920-e95595873a12 
X-Gogs-Event: push 
X-Gogs-Signature:  
X-Hub-Signature: sha1= 
X-Hub-Signature-256: sha256= 
 

Content 

{ 
  "ref": "refs/heads/master", 
  "before": "ee04027704214ef47399ac2e049dca515102a8a4", 
  "after": "ee04027704214ef47399ac2e049dca515102a8a4", 
  "compare_url": "", 
  "commits": [ 
    { 
      "id": "ee04027704214ef47399ac2e049dca515102a8a4", 
      "message": "Update Dockerfile", 
      "url": "http://git.example.com/gitea/bad-dockerfile/commit/ee04027704214ef47399ac2e049dca515102a8a4", 
      "author": { 
        "name": "Pandora", 
        "email": "58219367+Homopatrol@users.noreply.github.com", 
        "username": "" 
      }, 
      "committer": { 
        "name": "GitHub", 
        "email": "noreply@github.com", 
        "username": "" 
      }, 
      "verification": null, 
      "timestamp": "0001-01-01T00:00:00Z", 
      "added": null, 
      "removed": null, 
      "modified": "Dockerfile", 
    } 
  ], 
  "head_commit": { 
    "id": "ee04027704214ef47399ac2e049dca515102a8a4", 
    "message": "Update Dockerfile", 
    "url": "http://git.example.com/gitea/bad-dockerfile/commit/ee04027704214ef47399ac2e049dca515102a8a4", 
    "author": { 
      "name": "Pandora", 
      "email": "58219367+Homopatrol@users.noreply.github.com", 
      "username": "" 
    }, 
    "committer": { 
      "name": "GitHub", 
      "email": "noreply@github.com", 
      "username": "" 
    }, 
    "verification": null, 
    "timestamp": "0001-01-01T00:00:00Z", 
    "added": null, 
    "removed": null, 
    "modified": null 
  }, 
  "repository": { 
    "id": 1, 
    "owner": {"id":2,"login":"gitea","full_name":"","email":"gitea@admin.com","avatar_url":"http://git.example.com/user/avatar/gitea/-1","language":"","is_admin":false,"last_login":"0001-01-01T00:00:00Z","created":"2022-03-02T13:38:05Z","restricted":false,"active":false,"prohibit_login":false,"location":"","website":"","description":"","visibility":"public","followers_count":0,"following_count":0,"starred_repos_count":0,"username":"gitea"}, 
    "name": "bad-dockerfile", 
    "full_name": "gitea/bad-dockerfile", 
    "description": "A Dockerfile that creates an image with known vulnerabilities.", 
    "empty": false, 
    "private": false, 
    "fork": false, 
    "template": false, 
    "parent": null, 
    "mirror": true, 
    "size": 38, 
    "html_url": "http://git.example.com/gitea/bad-dockerfile", 
    "ssh_url": "git@git.example.com:gitea/bad-dockerfile.git", 
    "clone_url": "http://git.example.com/gitea/bad-dockerfile.git", 
    "original_url": "https://github.com/Homopatrol/bad-dockerfile", 
    "website": "", 
    "stars_count": 0, 
    "forks_count": 0, 
    "watchers_count": 1, 
    "open_issues_count": 0, 
    "open_pr_counter": 0, 
    "release_counter": 0, 
    "default_branch": "master", 
    "archived": false, 
    "created_at": "2022-03-02T13:39:00Z", 
    "updated_at": "2022-02-09T14:39:29Z", 
    "permissions": { 
      "admin": false, 
      "push": false, 
      "pull": false 
    }, 
    "has_issues": true, 
    "internal_tracker": { 
      "enable_time_tracker": true, 
      "allow_only_contributors_to_track_time": true, 
      "enable_issue_dependencies": true 
    }, 
    "has_wiki": true, 
    "has_pull_requests": true, 
    "has_projects": true, 
    "ignore_whitespace_conflicts": false, 
    "allow_merge_commits": true, 
    "allow_rebase": true, 
    "allow_rebase_explicit": true, 
    "allow_squash_merge": true, 
    "default_merge_style": "merge", 
    "avatar_url": "", 
    "internal": false, 
    "mirror_interval": "8h0m0s" 
  }, 
  "pusher": {"id":2,"login":"gitea","full_name":"","email":"gitea@admin.com","avatar_url":"http://git.example.com/user/avatar/gitea/-1","language":"","is_admin":false,"last_login":"0001-01-01T00:00:00Z","created":"2022-03-02T13:38:05Z","restricted":false,"active":false,"prohibit_login":false,"location":"","website":"","description":"","visibility":"public","followers_count":0,"following_count":0,"starred_repos_count":0,"username":"gitea"}, 
  "sender": {"id":2,"login":"gitea","full_name":"","email":"gitea@admin.com","avatar_url":"http://git.example.com/user/avatar/gitea/-1","language":"","is_admin":false,"last_login":"0001-01-01T00:00:00Z","created":"2022-03-02T13:38:05Z","restricted":false,"active":false,"prohibit_login":false,"location":"","website":"","description":"","visibility":"public","followers_count":0,"following_count":0,"starred_repos_count":0,"username":"gitea"} 
} 
```
## Setting up a Mirrored Repository
### Example Json payload for a Mirrored Repository

## CEL Filter 
```console
....
      interceptors:
       - cel:
           filter: "body.commits[0].modified[0] == 'Dockerfile' || body.commits[0].added[0] == 'Dockerfile' || body.commits[0].message[0] == 'Update Dockerfile'"
```
```console
{ 
.... 
  "commits": [ 
    { 
    .....
      "message": "Update Dockerfile", 
    ..... 
      "added": null, 
      "removed": null, 
      "modified": "Dockerfile", 
    } 
```
The filter will return a `TRUE` value if any of the following conditions are met:
- if "modified" = Dockerfile *OR*
- if "added" = Dockerfile  *OR*
- if "message" = "Update Dockerfile"

*NOTE* "message" is the commit message submitted, this is case sensitive.

## CEL Overlays 
*Note* the following configuration applies to a mirrored Gitea Repository

If the filter is successful the following Overlays will be applied

```console
....
           overlays:
           - key: timestamp
             expression: "body.commits[0].timestamp.truncate(10)"             
```
"timestamp": "0001-01-01T00:00:00Z" -> timestamp = "0001-01-01"

```console
           - key: giturl
             expression: "body.repository.original_url"
             
```
"original_url": "https://github.com/Homopatrol/bad-dockerfile", -> giturl = ""https://github.com/Homopatrol/bad-dockerfile"

```console
           - key: gitrevision
             expression: "body.ref.split('/')[2]"
....
```
"ref": "refs/heads/master", -> gitrevision = "master"

*Note* if using a mirrored repository in Gitea the alternative `gitrevision` expression should be applied:

```console
           - key: gitrevision
             expression: "body.ref"
....
```
"ref": "master", -> gitrevision = "master"